#!/usr/bin/perl

use FindBin;
use lib "$FindBin::Bin/../lib/superglue/perl5";

use Data::Dumper;
use ScriptDie;
use Superglue;
use XML::RPC;

my %opt = Superglue::getopt;
my %creds = Superglue::load_kv $opt{creds};
my %d = Superglue::read_delegation $opt{zone};

my $r;
my $api = XML::RPC->new($creds{url});

sub api_get {
	my $method = shift;
	$r = $api->call($method, $creds{apikey}, $opt{zone});
	sdie "$opt{zone} $method: $r->{faultString}"
	    if ref $r eq HASH and $r->{faultString};
	return $r;
}

if ($d{NS}) {
	my @ns = @{api_get('domain.info')->{nameservers}};
	my $ns_match = @ns == @{$d{NS}};
	for my $i (0 .. $#ns) {
		debug "$opt{zone} NS $ns[$i]";
		$ns_match = 0 if $ns[$i] ne $d{NS}[$i];
	}
	debug "NS match?", $ns_match ? 'yes' : 'no';
	my @glue = @{api_get('domain.host.list')};
	my $glue_match = @glue == scalar keys %{$d{glue}};
	for my $ns (sort { $a->{name} cmp $b->{name} } @glue) {
		$glue_match = 0 unless $d{glue}{$ns};
		my @a = sort @{$ns->{ips}};
		for my $i (0 .. $#a) {
			debug "$ns A $a[$i]"    if $a[$i] =~ $Superglue::re_ipv4;
			debug "$ns AAAA $a[$i]" if $a[$i] =~ $Superglue::re_ipv6;
			$glue_match = 0 if $glue_match
			    and $a[$i] ne $d{glue}{$ns}[$i];
		}
	}
	debug "glue match?", $glue_match ? 'yes' : 'no';
	if ($ns_match and $glue_match) {
		verbose "$opt{zone}: name server delegation matches";
	} else {
	}
}
if ($d{DNSKEY}) {
	my @keys = @{api_get('domain.dnssec.list')};
	for my $key (@keys) {
		debug "$opt{zone} DNSKEY $key->{flags} 3 $key->{algorithm} $key->{public_key}";
	}
}

__END__

=head1 NAME

superglue-gandi - synchronize DNS delegation with Gandi

=head1 SYNOPSIS

B<superglue-gandi> [B<--debug>|B<-d>] [B<--verbose>|B<-v>]
    [B<--not-really>|B<-n>] B<--creds>=I<file>|B<-c>I<file> I<domain>

B<superglue-gandi> B<-h>|B<--help>

=head1 DESCRIPTION

